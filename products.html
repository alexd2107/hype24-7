<script>
document.addEventListener("DOMContentLoaded", () => {
  const productGrid = document.querySelector(".product-grid");
  const searchInput = document.querySelector("#search");
  const sizeFilter = document.querySelector("#sizeFilter");

  const csvUrls = [
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?gid=10727842&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?gid=2080136486&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?gid=184084881&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?gid=1280515311&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?gid=1929692327&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?gid=1941135183&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?gid=234881949&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?gid=0&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?gid=834494988&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?gid=1649195567&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNR2S9ChRZ0QgYCH4EpAUK7KyVP-VwS4tTQhChdsGkA7h0sQNj0fjNvj-tDiAre66zzY6hIsKAdB-1/pub?gid=1978474466&single=true&output=csv"
  ];

  let allProducts = [];

  // Fetch and parse CSV
  async function fetchCSV(url) {
    const response = await fetch(url);
    const text = await response.text();
    return Papa.parse(text, { header: true }).data;
  }

  // Load all CSVs
  async function loadProducts() {
    let results = await Promise.all(csvUrls.map(url => fetchCSV(url)));
    allProducts = results.flat();

    // Build size filter dynamically
    const sizes = new Set();
    allProducts.forEach(p => {
      if (p.Size) {
        p.Size.split(",").map(s => s.trim()).forEach(s => sizes.add(s));
      }
    });

    sizeFilter.innerHTML = [...sizes]
      .sort((a, b) => parseFloat(a) - parseFloat(b))
      .map(size => `<option value="${size}">${size}</option>`)
      .join("");

    renderProducts(allProducts);
  }

  // Render products
  function renderProducts(products) {
    productGrid.innerHTML = "";

    if (products.length === 0) {
      productGrid.innerHTML = "<p>No products found.</p>";
      return;
    }

    products.forEach(product => {
      const card = document.createElement("div");
      card.classList.add("product-card");

      card.innerHTML = `
        <h3>${product.Name || "Unnamed Shoe"}</h3>
        <p><strong>Price:</strong> ${product.Price || "N/A"}</p>
        <p><strong>Sizes:</strong> ${product.Size || "N/A"}</p>
      `;

      productGrid.appendChild(card);
    });
  }

  // Filter logic
  function filterProducts() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedSizes = Array.from(sizeFilter.selectedOptions).map(o => o.value);

    let filtered = allProducts.filter(p => {
      const matchesSearch = p.Name?.toLowerCase().includes(searchTerm);
      const matchesSize =
        selectedSizes.length === 0 ||
        selectedSizes.some(size => p.Size?.includes(size));
      return matchesSearch && matchesSize;
    });

    renderProducts(filtered);
  }

  searchInput.addEventListener("input", filterProducts);
  sizeFilter.addEventListener("change", filterProducts);

  loadProducts();
});
</script>
